<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Trivia Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }

    h1 {
      margin-bottom: 20px;
    }

    input {
      width: 100%;
      max-width: 650px;
      padding: 12px;
      border-radius: 10px;
      border: none;
      outline: none;
      background: #222;
      color: #eee;
      margin-bottom: 16px;
      font-size: 16px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      background: #4caf50;
      color: white;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background: #43a047;
    }

    #toast {
      margin-top: 20px;
      padding: 15px;
      background: #333;
      border-radius: 8px;
      display: none;
      max-width: 650px;
      font-size: 15px;
    }

    .success {
      background: #2e7d32;
    }

    .error {
      background: #c62828;
    }
  </style>
</head>

<body>

  <h1>AI Trivia Generator</h1>

  <input id="triviaId" placeholder="Enter triviaId (e.g., genz_trivia_1)" />
  <input id="topicInput" placeholder="Enter topic (e.g., Gen Alpha slang)" />
  <input id="countInput" placeholder="How many questions? (Default: 40)" />

  <button onclick="generateAndUpload()">Generate & Upload</button>

  <div id="toast"></div>

  <script>
    // ‚ö†Ô∏è IMPORTANT: Never commit API keys to git!
    // In production, use environment variables or a secure backend
    const OPENAI_API_KEY = "YOUR_OPENAI_API_KEY_HERE";

    // üî• Automatically create triviaId like <topic>_trivia_<nextIndex>
    async function generateTriviaId(topic) {
      const sanitized = topic
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "");

      const prefix = sanitized + "_trivia_";

      // Firestore REST API
      const url =
        "https://firestore.googleapis.com/v1/projects/emojivia-f5bd5/databases/(default)/documents/trivia";

      const res = await fetch(url);
      const data = await res.json();

      if (!data.documents) return prefix + "1";

      let maxIndex = 0;

      for (const doc of data.documents) {
        const fullName = doc.name.split("/").pop(); // extract document ID

        if (fullName.startsWith(prefix)) {
          const num = parseInt(fullName.replace(prefix, ""), 10);
          if (!isNaN(num) && num > maxIndex) maxIndex = num;
        }
      }

      const nextId = maxIndex + 1;
      return prefix + nextId;
    }

    async function generateAndUpload() {
      const topic = document.getElementById("topicInput").value.trim();
      let count = parseInt(document.getElementById("countInput").value.trim());
      if (!count || isNaN(count)) count = 40;

      if (!topic) return showToast("Please enter a topic.", "error");

      showToast("‚è≥ Generating trivia ID...", "success");

      // üî• Step 1: auto-generate triviaId
      const triviaId = await generateTriviaId(topic);

      showToast("‚ú® Trivia ID created: " + triviaId, "success");

      // üî• Step 2: Generate questions from OpenAI
      showToast("ü§ñ Generating trivia using AI...", "success");

      const systemPrompt = `
You create emoji-only trivia questions.
Return ONLY a JSON array. Format:
[
  {
    "id": 1,
    "question": "üíÄüòÇüì±",
    "options": ["NPC moment", "I‚Äôm dead (laughing)", "Phone lag", "L take"],
    "answer": "I‚Äôm dead (laughing)"
  }
]

Rules:
- JSON array only.
- id starts at 1.
- question is ONLY emojis.
- 4 options.
- answer must match one option exactly.
Topic: ${topic}
`;

      const userPrompt = `Generate ${count} questions for topic: ${topic}`;

      let aiJson;

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: "gpt-4.1-mini",
            messages: [
              { role: "system", content: systemPrompt },
              { role: "user", content: userPrompt }
            ],
            max_tokens: 4000
          })
        });

        const data = await response.json();
        aiJson = JSON.parse(data.choices[0].message.content);

      } catch (e) {
        return showToast("‚ùå AI generation error: " + e.message, "error");
      }

      showToast("‚¨ÜÔ∏è Uploading generated questions...", "success");

      // üî• Step 3: Upload to Firestore using Cloud Function
      const cloudFn =
        "https://us-central1-emojivia-f5bd5.cloudfunctions.net/createTriviaQuestions";

      try {
        const res = await fetch(cloudFn + "?triviaId=" + triviaId, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(aiJson),
        });

        const result = await res.json();

        if (res.ok) {
          showToast("üéâ Trivia saved: " + triviaId, "success");
        } else {
          showToast("‚ùå Upload failed: " + (result.message || "Unknown error"), "error");
        }
      } catch (err) {
        showToast("‚ùå Network error: " + err.message, "error");
      }
    }

    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.innerText = message;
      toast.className = type;
      toast.style.display = "block";
      setTimeout(() => (toast.style.display = "none"), 4000);
    }
  </script>


</body>

</html>